<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Rang-System ‚Äî mit Rollen & Admin-Panel</title>
<style>
  :root{
    --bg-1: #0d1117;
    --card: rgba(10,15,30,0.85);
    --accent: #2563eb;
    --muted: #9aa0a6;
    --glass: rgba(15,23,42,0.6);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(135deg,#06070a 0%,#0a0f1a 50%);
    color:#e6eef8;
    min-height:100vh;
    display:flex;
  }

  /* Sidebar left */
  .sidebar{
    width:300px;
    background: linear-gradient(180deg, rgba(8,12,25,0.96), rgba(6,10,18,0.96));
    padding:20px;
    border-right: 1px solid rgba(255,255,255,0.03);
    min-height:100vh;
    position:fixed;
    left:0; top:0; bottom:0;
    overflow:auto;
  }
  .logo{font-size:22px; font-weight:700; letter-spacing:0.2px; margin-bottom:18px}
  .user-short{display:flex; gap:12px; align-items:center; margin-bottom:16px}
  .avatar{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#1e3a8a,#2563eb);display:flex;align-items:center;justify-content:center;font-size:20px}
  .mini{font-size:13px;color:var(--muted)}

  .menu-title{margin-top:14px;color:var(--muted);font-size:12px;text-transform:uppercase}
  .menu-item{padding:10px;border-radius:8px;cursor:pointer;margin-top:8px;display:flex;align-items:center;gap:10px}
  .menu-item:hover{background:rgba(37,99,235,0.06)}
  .menu-item.active{background:rgba(37,99,235,0.12);border-left:3px solid var(--accent);padding-left:7px}

  .main{
    margin-left:320px;
    padding:36px;
    width:100%;
  }

  .page-header{display:flex;align-items:center;justify-content:space-between;gap:16px}
  h1{margin:0;font-size:28px}
  p.lead{color:var(--muted);margin-top:6px;margin-bottom:18px}

  .grid{display:grid;gap:18px}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
  .row{display:flex;gap:12px;align-items:center}
  .btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn-primary{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#dfe7ff}
  .muted{color:var(--muted);font-size:13px}

  /* lists */
  .list{display:flex;flex-direction:column;gap:10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .role-badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;background:linear-gradient(90deg,#ffd700,#ffaa00);color:#111}

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{width:520px;background:rgba(8,12,20,0.95);padding:20px;border-radius:12px}
  .field{display:flex;flex-direction:column;margin-top:8px}
  label{font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(12,16,28,0.6);color:#e6eef8}
  textarea{min-height:90px}

  /* ban card style similar to screenshot */
  .ban-card{background:#0b0d11;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:14px;align-items:flex-start}
  .ban-left{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#1e3a8a,#2563eb);display:flex;align-items:center;justify-content:center;font-weight:700}
  .ban-content h3{margin:0;font-size:16px}
  .ban-meta{color:#aab3bd;font-size:13px;margin-top:6px}
  .badge-red{background:rgba(239,68,68,0.12);color:#ffb4b4;padding:6px 8px;border-radius:8px;font-weight:700;font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .danger{color:#ff9b9b}

  /* responsive */
  @media (max-width:900px){
    .sidebar{position:relative;width:100%;height:auto}
    .main{margin-left:0;padding:18px}
  }
</style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">Discord ‚Äî Rang-System</div>
    <div class="user-short">
      <div class="avatar" id="avatar">üë§</div>
      <div>
        <div id="displayName">Guest</div>
        <div class="mini" id="displayId">#0000</div>
      </div>
    </div>

    <div class="menu-title">Navigation</div>
    <div class="menu-item active" data-section="servers" onclick="navigate(event)">
      üè† Server
    </div>
    <div class="menu-item" data-section="roles" onclick="navigate(event)">
      ‚≠ê Rollen
    </div>
    <div class="menu-item" data-section="admin" onclick="navigate(event)" id="adminMenuItem" style="display:none">
      üõ†Ô∏è Admin-Panel
    </div>
    <div class="menu-item" data-section="bans" onclick="navigate(event)">
      ‚õî Bans
    </div>

    <div class="menu-title">Server</div>
    <div id="serverList"></div>

    <div style="margin-top:20px">
      <button class="btn btn-primary" onclick="openModal('createServerModal')">Neuen Server</button>
    </div>

    <div style="margin-top:16px">
      <button class="btn btn-ghost" onclick="logout()">Abmelden</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="page-header">
      <div>
        <h1 id="pageTitle">Server</h1>
        <p class="lead" id="pageDesc">W√§hle ein Server aus oder erstelle einen neuen.</p>
      </div>
      <div class="row">
        <div class="muted">Angemeldet als:</div>
        <div style="width:12px"></div>
        <div id="topUserName" style="font-weight:800">Guest</div>
      </div>
    </div>

    <!-- Servers -->
    <section id="serversSection" class="grid">
      <div class="card">
        <h3>Deine Server</h3>
        <p class="muted">Klicke auf einen Server in der Sidebar, um ihn zu w√§hlen.</p>
        <div id="serversGrid" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>
      </div>
    </section>

    <!-- Roles -->
    <section id="rolesSection" style="display:none" class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3>Rollen verwalten</h3>
            <div class="muted">Owner kann Rollen erstellen / bearbeiten.</div>
          </div>
          <div>
            <button class="btn btn-primary" onclick="openModal('createRoleModal')">Rolle erstellen</button>
          </div>
        </div>

        <div style="margin-top:12px" id="rolesList"></div>
      </div>

      <div class="card">
        <h3>Mitglieder & Rollen zuweisen</h3>
        <p class="muted">Erstelle Mitglieder (Demo) und weise Rollen zu.</p>
        <div style="display:flex;gap:8px">
          <input id="newMemberName" placeholder="Benutzername" />
          <button class="btn btn-primary" onclick="addMember()">Mitglied hinzuf√ºgen</button>
        </div>
        <div id="membersList" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Admin Panel -->
    <section id="adminSection" style="display:none" class="grid">
      <div class="card">
        <h3>Admin-Panel (Manage-Players)</h3>
        <p class="muted">Nur sichtbar f√ºr Owner oder Nutzer mit der Permission "Manage-Players".</p>
        <div style="margin-top:12px" id="adminControls">
          <div class="small">W√§hle ein Mitglied und f√ºhre Verwaltungsaktionen aus (Ban, Unban, Kick - Demo).</div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <select id="adminTargetSelect"></select>
            <button class="btn btn-primary" onclick="openModal('banModal')">Ban</button>
            <button class="btn btn-ghost" onclick="kickDemo()">Kick (Demo)</button>
            <button class="btn btn-ghost" onclick="unbanSelected()">Unban</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Banned √úbersicht</h3>
        <div id="banOverview" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Bans page -->
    <section id="bansSection" style="display:none" class="grid">
      <div class="card">
        <h3>Aktuelle Bans</h3>
        <p class="muted">Hier erscheinen alle aktiven Banns mit Grund & Dauer.</p>
        <div id="bansGrid" style="margin-top:12px;display:flex;flex-direction:column;gap:10px"></div>
      </div>
    </section>

  </main>

  <!-- Modals -->
  <div class="modal-back" id="modalBack">
    <div class="modal" id="createServerModal" style="display:none">
      <h3>Neuen Server erstellen</h3>
      <div class="field">
        <label>Server Name</label>
        <input id="serverNameInput" placeholder="Mein Server" />
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeModal('createServerModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="createServer()">Erstellen</button>
      </div>
    </div>

    <div class="modal" id="createRoleModal" style="display:none">
      <h3>Rolle erstellen / bearbeiten</h3>
      <div class="field"><label>Rollen-Name</label><input id="roleNameInput" /></div>
      <div class="field"><label>Farbe / Badge (Text)</label><input id="roleBadgeInput" placeholder="z.B. Support" /></div>
      <div class="field">
        <label>Berechtigungen</label>
        <div style="display:flex;flex-direction:column;gap:6px">
          <label><input type="checkbox" id="permManagePlayers"> Manage-Players</label>
          <label><input type="checkbox" id="permBanMembers"> Ban-Members</label>
          <label><input type="checkbox" id="permCreateRoles"> Create-Roles</label>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeModal('createRoleModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveRole()">Speichern</button>
      </div>
    </div>

    <div class="modal" id="banModal" style="display:none">
      <h3>Spieler bannen</h3>
      <div class="field">
        <label>Betroffener Spieler</label>
        <select id="banTargetSelect"></select>
      </div>
      <div class="field"><label>Grund (erforderlich)</label><input id="banReason" placeholder="Grund eingeben..." /></div>
      <div class="field">
        <label>Dauer</label>
        <select id="banDuration">
          <option value="3600">1 Stunde</option>
          <option value="86400">1 Tag</option>
          <option value="604800">7 Tage</option>
          <option value="2592000">30 Tage</option>
          <option value="0">Permanent</option>
          <option value="custom">Benutzerdefiniert (Sekunden)</option>
        </select>
        <input id="banCustomSeconds" style="display:none;margin-top:8px" placeholder="Sekunden (z.B. 7200)" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeModal('banModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="confirmBan()">Ban ausf√ºhren</button>
      </div>
    </div>
  </div>

<script>
/*
  Voll funktionsf√§hige clientseitige App mit:
  - Owner / Rollen / Berechtigungen
  - Admin-Panel nur f√ºr Nutzer mit Manage-Players
  - Ban-System mit Grund + Dauer (speichert in localStorage)
  - Sicherheit: alle Aktionen pr√ºfen Permissions
*/

/* ========== simple "Auth" (Demo) ========== */
// Demo-Login automatisch: Nutzer kann seinen Namen √§ndern
let currentUser = { id: 'u_'+Math.floor(Math.random()*999999), name: 'DemoUser', discriminator: '0001' };
document.getElementById('displayName').textContent = currentUser.name;
document.getElementById('displayId').textContent = '#'+currentUser.discriminator;
document.getElementById('topUserName').textContent = currentUser.name;

/* ========== Storage helpers ========== */
const STORAGE_KEY = 'discord_rang_system_v1';
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return { servers:[], roles:{}, members:{}, bans:[] };
  try{ return JSON.parse(raw); }catch(e){ return { servers:[], roles:{}, members:{}, bans:[] }; }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
let state = loadState();

/* ========== Data model
  state = {
    servers: [{id,name,ownerId}],
    roles: { serverId: [ {id,name,badge,perms:{...}} ] },
    members: { serverId: [ {id,name,roles:[roleId,...]} ] },
    bans: [ {id, serverId, userId, userName, reason, expiresAt (ts or 0), bannedBy} ]
  }
 ========== */

/* ====== Utility ====== */
function uid(prefix='id'){ return prefix + '_' + Date.now() + '_' + Math.floor(Math.random()*9999) }

/* ====== Navigation & UI ====== */
function navigate(e){
  const section = e.currentTarget.dataset.section;
  document.querySelectorAll('.menu-item').forEach(it => it.classList.remove('active'));
  e.currentTarget.classList.add('active');
  showSection(section);
}
function showSection(section){
  document.getElementById('serversSection').style.display = section==='servers' || !section ? '' : 'none';
  document.getElementById('rolesSection').style.display = section==='roles' ? '' : 'none';
  document.getElementById('adminSection').style.display = section==='admin' ? '' : 'none';
  document.getElementById('bansSection').style.display = section==='bans' ? '' : 'none';
  // update content when switching
  renderServersGrid();
  renderRoles();
  renderMembers();
  renderAdmin();
  renderBansGrid();
}

/* ====== Modals ====== */
function openModal(id){
  document.getElementById('modalBack').style.display = 'flex';
  document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}
function closeModal(id){
  document.getElementById('modalBack').style.display = 'none';
  if(id) document.getElementById(id).style.display = 'none';
}

/* ====== Server handling ====== */
function createServer(){
  const name = document.getElementById('serverNameInput').value.trim();
  if(!name){ alert('Bitte Servernamen angeben'); return; }
  const server = { id: uid('srv'), name, ownerId: currentUser.id };
  state.servers.push(server);
  state.roles[server.id] = []; // roles array
  state.members[server.id] = [ { id: currentUser.id, name: currentUser.name, roles: [] } ]; // owner is member
  // automatically create an "Owner"-role that cannot be deleted and gives all perms
  const ownerRole = { id: uid('role'), name:'Owner', badge:'Owner', perms:{ ManagePlayers:true, BanMembers:true, CreateRoles:true }, immutable:true };
  state.roles[server.id].push(ownerRole);
  // assign owner role to user
  state.members[server.id][0].roles.push(ownerRole.id);
  saveState();
  closeModal('createServerModal');
  document.getElementById('serverNameInput').value='';
  updateServerListUI();
  selectServer(server.id);
}

function updateServerListUI(){
  const list = document.getElementById('serverList');
  list.innerHTML = state.servers.map(s=>{
    const activeClass = (currentServer && currentServer.id === s.id) ? 'background:rgba(37,99,235,0.08);padding:8px;border-radius:8px' : '';
    return `<div class="menu-item" style="${activeClass}" onclick="selectServer('${s.id}')">${s.name}</div>`
  }).join('') || '<div class="muted">Keine Server</div>';
  renderServersGrid();
}

/* ====== current server selection ====== */
let currentServer = state.servers[0] || null;
function selectServer(id){
  currentServer = state.servers.find(s=>s.id===id) || null;
  if(!currentServer){ alert('Server nicht gefunden'); return; }
  document.getElementById('pageTitle').textContent = currentServer.name;
  document.getElementById('pageDesc').textContent = 'Verwalte Server: ' + currentServer.name;
  updateServerListUI();
  // show Admin menu item only if current user has perms
  toggleAdminMenu();
  showSection('servers');
}

/* ====== Render servers grid ====== */
function renderServersGrid(){
  const grid = document.getElementById('serversGrid');
  if(!grid) return;
  if(state.servers.length===0) {
    grid.innerHTML = `<div class="card">Du hast noch keine Server. Erstelle einen neuen.</div>`;
    return;
  }
  grid.innerHTML = state.servers.map(s=>{
    const mcount = (state.members[s.id]||[]).length;
    return `<div class="card" style="cursor:pointer" onclick="selectServer('${s.id}')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900">${s.name}</div>
          <div class="muted" style="margin-top:6px">${mcount} Mitglieder</div>
        </div>
        <div class="role-badge" style="background:linear-gradient(90deg,#1e3a8a,#2563eb)">Server</div>
      </div>
    </div>`;
  }).join('');
}

/* ====== Roles ====== */
let editingRole = null;
function renderRoles(){
  if(!currentServer) { document.getElementById('rolesList').innerHTML = '<div class="muted">W√§hle zuerst einen Server.</div>'; return; }
  const roles = state.roles[currentServer.id] || [];
  const html = roles.map(r=>{
    const perms = Object.keys(r.perms||{}).filter(k=>r.perms[k]).join(', ') || 'keine';
    return `<div class="list-item" style="margin-top:8px">
      <div>
        <div style="font-weight:800">${r.name} ${r.immutable?'<span class="muted" style="font-size:12px;margin-left:8px">(System)</span>':''}</div>
        <div class="muted" style="margin-top:6px">Permissions: ${perms}</div>
      </div>
      <div style="display:flex;gap:8px">
        ${canCurrentUser('CreateRoles') && !r.immutable ? `<button class="btn btn-ghost" onclick="editRole('${r.id}')">Bearbeiten</button>` : ''}
        ${canCurrentUser('CreateRoles') && !r.immutable ? `<button class="btn" style="background:rgba(220,38,38,0.12);color:#ffb4b4" onclick="deleteRole('${r.id}')">L√∂schen</button>` : ''}
      </div>
    </div>`;
  }).join('');
  document.getElementById('rolesList').innerHTML = html || '<div class="muted">Keine Rollen</div>';
}

function openCreateRole(){
  editingRole = null;
  document.getElementById('roleNameInput').value='';
  document.getElementById('roleBadgeInput').value='';
  document.getElementById('permManagePlayers').checked=false;
  document.getElementById('permBanMembers').checked=false;
  document.getElementById('permCreateRoles').checked=false;
  openModal('createRoleModal');
}
window.openCreateRole = openCreateRole; // expose

function saveRole(){
  if(!currentServer) { alert('W√§hle Server'); return; }
  if(!canCurrentUser('CreateRoles')) { alert('Keine Berechtigung Rollen zu erstellen'); closeModal('createRoleModal'); return; }
  const name = document.getElementById('roleNameInput').value.trim();
  if(!name){ alert('Rollenname erforderlich'); return; }
  const badge = document.getElementById('roleBadgeInput').value.trim() || name;
  const perms = { ManagePlayers: !!document.getElementById('permManagePlayers').checked,
                  BanMembers: !!document.getElementById('permBanMembers').checked,
                  CreateRoles: !!document.getElementById('permCreateRoles').checked };
  if(editingRole){
    const arr = state.roles[currentServer.id];
    const idx = arr.findIndex(r=>r.id===editingRole);
    if(idx>=0){
      arr[idx].name = name; arr[idx].badge = badge; arr[idx].perms = perms;
    }
  } else {
    const role = { id: uid('role'), name, badge, perms };
    state.roles[currentServer.id].push(role);
  }
  saveState();
  closeModal('createRoleModal');
  renderRoles();
  renderMembers();
}

function editRole(roleId){
  const role = (state.roles[currentServer.id]||[]).find(r=>r.id===roleId);
  if(!role) return;
  editingRole = roleId;
  document.getElementById('roleNameInput').value = role.name;
  document.getElementById('roleBadgeInput').value = role.badge || role.name;
  document.getElementById('permManagePlayers').checked = !!role.perms.ManagePlayers;
  document.getElementById('permBanMembers').checked = !!role.perms.BanMembers;
  document.getElementById('permCreateRoles').checked = !!role.perms.CreateRoles;
  openModal('createRoleModal');
}

function deleteRole(roleId){
  if(!confirm('Rolle wirklich l√∂schen?')) return;
  state.roles[currentServer.id] = (state.roles[currentServer.id]||[]).filter(r=>r.id!==roleId);
  // remove role from members
  (state.members[currentServer.id]||[]).forEach(m => {
    m.roles = (m.roles || []).filter(rr=>rr!==roleId);
  });
  saveState();
  renderRoles();
  renderMembers();
}

/* ====== Members (Demo) ====== */
function addMember(){
  if(!currentServer){ alert('W√§hle Server'); return; }
  const name = document.getElementById('newMemberName').value.trim();
  if(!name) return;
  const member = { id: uid('m'), name, roles: [] };
  state.members[currentServer.id].push(member);
  saveState();
  document.getElementById('newMemberName').value='';
  renderMembers();
  renderAdmin();
}

function renderMembers(){
  if(!currentServer) return;
  const list = document.getElementById('membersList');
  const members = state.members[currentServer.id] || [];
  const roles = state.roles[currentServer.id] || [];
  list.innerHTML = members.map(m=>{
    const roleBadges = (m.roles||[]).map(rid=>{
      const r = roles.find(rr=>rr.id===rid);
      return r ? `<span style="margin-right:6px" class="role-badge">${r.badge||r.name}</span>` : '';
    }).join('');
    // role assign select
    const roleOptions = roles.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
    return `<div class="list-item">
      <div>
        <div style="font-weight:800">${m.name}${m.id===currentServer.ownerId ? ' <span class="muted" style="font-size:12px">(Owner)</span>' : ''}</div>
        <div class="muted">${roleBadges || '<span class="muted">keine Rolle</span>'}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="assign_${m.id}">
          <option value="">Rolle hinzuf√ºgen</option>
          ${roleOptions}
        </select>
        <button class="btn btn-ghost" onclick="assignRoleToMember('${m.id}')">Zuweisen</button>
        ${ (m.id !== currentServer.ownerId) ? `<button class="btn" style="background:rgba(220,38,38,0.12);color:#ffb4b4" onclick="removeMember('${m.id}')">Entfernen</button>` : '' }
      </div>
    </div>`;
  }).join('');
}

function assignRoleToMember(memberId){
  const select = document.getElementById('assign_'+memberId);
  if(!select) return;
  const roleId = select.value;
  if(!roleId) return;
  // permission: only Owner or roles with CreateRoles can assign roles (you set policy)
  if(!canCurrentUser('CreateRoles')) { alert('Keine Berechtigung Rollen zu vergeben'); return; }
  const member = (state.members[currentServer.id]||[]).find(m=>m.id===memberId);
  if(!member) return;
  if(!member.roles) member.roles=[];
  if(member.roles.includes(roleId)){ alert('Benutzer hat die Rolle bereits'); return; }
  member.roles.push(roleId);
  saveState();
  renderMembers();
  renderAdmin();
}

function removeMember(memberId){
  if(!confirm('Mitglied entfernen?')) return;
  state.members[currentServer.id] = (state.members[currentServer.id]||[]).filter(m=>m.id!==memberId);
  saveState();
  renderMembers();
  renderAdmin();
}

/* ====== Permissions check ====== */
function canCurrentUser(permName){
  if(!currentServer) return false;
  if(currentUser.id === currentServer.ownerId) return true;
  const members = state.members[currentServer.id]||[];
  const me = members.find(m => m.id === currentUser.id);
  if(!me) return false;
  const roles = state.roles[currentServer.id] || [];
  for(const rid of (me.roles||[])){
    const r = roles.find(rr=>rr.id===rid);
    if(r && r.perms && r.perms[permName]) return true;
  }
  return false;
}

function toggleAdminMenu(){
  const item = document.getElementById('adminMenuItem');
  if(canCurrentUser('ManagePlayers') || currentUser.id === (currentServer && currentServer.ownerId)) item.style.display = '';
  else item.style.display = 'none';
}

/* ====== Admin rendering ====== */
function renderAdmin(){
  toggleAdminMenu();
  // admin target select
  const sel = document.getElementById('adminTargetSelect');
  const banSel = document.getElementById('banTargetSelect');
  if(!currentServer) return;
  const members = state.members[currentServer.id]||[];
  const options = members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
  if(sel) sel.innerHTML = options;
  if(banSel) banSel.innerHTML = options;
  // ban overview
  renderBanOverview();
}

/* ====== Ban System ====== */
function openBanModalFor(memberId){
  if(memberId) document.getElementById('banTargetSelect').value = memberId;
  document.getElementById('banCustomSeconds').style.display = 'none';
  openModal('banModal');
}
window.openBanModalFor = openBanModalFor;

document.getElementById('banDuration').addEventListener('change', function(){
  if(this.value === 'custom') document.getElementById('banCustomSeconds').style.display = '';
  else document.getElementById('banCustomSeconds').style.display = 'none';
});

function confirmBan(){
  if(!currentServer){ alert('W√§hle Server'); return; }
  // permission: ManagePlayers OR BanMembers
  if(!(canCurrentUser('ManagePlayers') || canCurrentUser('BanMembers'))){
    alert('Keine Berechtigung zu bannen');
    closeModal('banModal');
    return;
  }
  const targetId = document.getElementById('banTargetSelect').value;
  const reason = document.getElementById('banReason').value.trim();
  let duration = document.getElementById('banDuration').value;
  const custom = document.getElementById('banCustomSeconds').value.trim();
  if(!targetId || !reason){ alert('Ziel & Grund erforderlich'); return; }
  if(duration === 'custom'){
    duration = parseInt(custom||'0',10);
    if(isNaN(duration) || duration < 0){ alert('Ung√ºltige Dauer'); return; }
  } else {
    duration = parseInt(duration,10);
  }
  const member = (state.members[currentServer.id]||[]).find(m=>m.id===targetId);
  if(!member){ alert('Mitglied nicht gefunden'); return; }
  const expiresAt = duration === 0 ? 0 : Date.now() + duration*1000;
  // create ban entry
  const ban = {
    id: uid('ban'),
    serverId: currentServer.id,
    userId: member.id,
    userName: member.name,
    reason,
    expiresAt,
    bannedBy: currentUser.name,
    createdAt: Date.now()
  };
  state.bans.push(ban);
  saveState();
  closeModal('banModal');
  renderBansGrid();
  renderBanOverview();
  renderAdmin();
  alert('Ban ausgef√ºhrt: ' + member.name);
}

function unbanSelected(){
  if(!currentServer) return;
  if(!(canCurrentUser('ManagePlayers') || canCurrentUser('BanMembers'))){
    alert('Keine Berechtigung Unban');
    return;
  }
  const sel = document.getElementById('adminTargetSelect');
  const memberId = sel.value;
  if(!memberId) return alert('W√§hle ein Mitglied');
  // remove bans for that user on this server
  state.bans = state.bans.filter(b => !(b.serverId===currentServer.id && b.userId===memberId));
  saveState();
  renderBansGrid();
  renderBanOverview();
  alert('Unban ausgef√ºhrt');
}

function kickDemo(){
  // purely demo: remove member but do not ban
  if(!currentServer) return;
  if(!canCurrentUser('ManagePlayers')) return alert('Keine Berechtigung');
  const sel = document.getElementById('adminTargetSelect');
  const id = sel.value;
  if(!id) return alert('W√§hle Mitglied');
  if(id === currentServer.ownerId) return alert('Owner kann nicht gekickt werden');
  state.members[currentServer.id] = state.members[currentServer.id].filter(m=>m.id!==id);
  saveState();
  renderMembers();
  renderAdmin();
  alert('Mitglied gekickt (Demo): ' + id);
}

/* ====== Bans UI ====== */
function renderBansGrid(){
  const grid = document.getElementById('bansGrid');
  if(!grid) return;
  // filter active bans for current server
  const rows = state.bans.filter(b=>b.serverId === (currentServer && currentServer.id));
  if(rows.length===0){ grid.innerHTML = '<div class="muted">Keine aktiven Bans</div>'; return; }
  grid.innerHTML = rows.map(b=>{
    const remaining = b.expiresAt === 0 ? 'Permanent' : formatRemaining(b.expiresAt - Date.now());
    const expired = (b.expiresAt !==0 && Date.now() > b.expiresAt);
    return `<div class="ban-card">
      <div class="ban-left">${b.userName.charAt(0).toUpperCase()}</div>
      <div class="ban-content" style="flex:1">
        <h3>${b.userName} <span class="muted" style="font-size:13px">‚Äî gebannt von ${b.bannedBy}</span></h3>
        <div class="ban-meta">${b.reason}</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <div class="badge-red">${expired ? 'Abgelaufen' : remaining}</div>
          <div class="small">erstellt: ${new Date(b.createdAt).toLocaleString()}</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${ (canCurrentUser('ManagePlayers') || canCurrentUser('BanMembers')) ? `<button class="btn" onclick="removeBan('${b.id}')">Unban</button>` : '' }
      </div>
    </div>`;
  }).join('');
}

function renderBanOverview(){
  const el = document.getElementById('banOverview');
  if(!el) return;
  const rows = state.bans.filter(b=>b.serverId === (currentServer && currentServer.id));
  if(rows.length===0){ el.innerHTML = '<div class="muted">Keine Bans</div>'; return; }
  el.innerHTML = rows.map(b=>{
    const remaining = b.expiresAt === 0 ? 'Permanent' : formatRemaining(b.expiresAt - Date.now());
    return `<div class="list-item">
      <div>
        <div style="font-weight:800">${b.userName}</div>
        <div class="muted">${b.reason} ‚Äî ${remaining}</div>
      </div>
      <div>
        <button class="btn btn-ghost" onclick="removeBan('${b.id}')">Unban</button>
      </div>
    </div>`;
  }).join('');
}

/* remove ban */
function removeBan(banId){
  if(!(canCurrentUser('ManagePlayers') || canCurrentUser('BanMembers'))){ alert('Keine Berechtigung'); return; }
  state.bans = state.bans.filter(b=>b.id!==banId);
  saveState();
  renderBansGrid();
  renderBanOverview();
}

/* auto-clean expired bans periodically */
setInterval(()=>{
  const before = state.bans.length;
  state.bans = state.bans.filter(b => !(b.expiresAt !==0 && Date.now() > b.expiresAt));
  if(state.bans.length !== before){ saveState(); renderBansGrid(); renderBanOverview(); }
}, 5000);

/* helpers */
function formatRemaining(ms){
  if(ms <= 0) return 'abgelaufen';
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400); const h = Math.floor((s%86400)/3600); const m = Math.floor((s%3600)/60); const sec = s%60;
  if(d>0) return `${d}d ${h}h ${m}m`;
  if(h>0) return `${h}h ${m}m`;
  if(m>0) return `${m}m ${sec}s`;
  return `${sec}s`;
}

/* initial rendering */
function init(){
  // if no server exists, leave blank until user creates
  updateServerListUI();
  if(state.servers.length>0 && !currentServer) selectServer(state.servers[0].id);
  renderServersGrid();
  renderRoles();
  renderMembers();
  renderAdmin();
  renderBansGrid();
  // close modal on background click
  document.getElementById('modalBack').addEventListener('click', (ev)=>{
    if(ev.target === document.getElementById('modalBack')){
      document.getElementById('modalBack').style.display = 'none';
      document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
    }
  });
}

init();

/* Bindings for UI buttons */
window.createServer = createServer;
window.openModal = openModal;
window.closeModal = closeModal;
window.saveRole = saveRole;
window.editRole = editRole;
window.deleteRole = deleteRole;
window.renderMembers = renderMembers;
window.renderRoles = renderRoles;
window.selectServer = selectServer;
window.assignRoleToMember = assignRoleToMember;
window.addMember = addMember;
window.openBanModalFor = openBanModalFor;
window.confirmBan = confirmBan;
window.unbanSelected = unbanSelected;
window.removeBan = removeBan;
window.openCreateRoleModal = function(){ if(!currentServer) return alert('W√§hle Server'); if(!canCurrentUser('CreateRoles')) return alert('Keine Berechtigung'); openModal('createRoleModal'); }
window.openCreateRoleModal = openCreateRoleModal;

/* small UI helpers to open role modal from sidebar button */
document.querySelectorAll('[data-section]').forEach(it=>it.addEventListener('click', ()=>{}));

</script>
</body>
</html>
