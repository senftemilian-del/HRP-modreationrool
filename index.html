<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rang-System ‚Äî Login, Server, Admin & Debug</title>
<style>
:root{
  --bg-1:#03102a; --bg-2:#07142a;
  --accent:#1f4bd6; --accent-2:#2b62ff;
  --card: rgba(10,15,30,0.92);
  --muted:#98a3b3;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:#e6eef8;min-height:100vh;}
.bg-deco{position:fixed;inset:0;pointer-events:none;z-index:0}
.bg-deco .orb{position:absolute;width:520px;height:520px;border-radius:50%;filter:blur(60px);opacity:0.12}
.bg-orb-1{left:6%;top:6%;background:radial-gradient(circle,#12306a,transparent 50%)}
.bg-orb-2{right:6%;bottom:8%;width:420px;height:420px;background:radial-gradient(circle,#0f2f70,transparent 50%);opacity:0.08}

.container{position:relative;z-index:1;display:flex;gap:20px;padding:32px;align-items:stretch;min-height:calc(100vh - 64px);}

/* left - welcome / login */
.welcome{width:44%;min-width:360px;padding:36px;display:flex;flex-direction:column;gap:18px;justify-content:center}
.hero{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:14px;box-shadow:0 10px 40px rgba(2,6,23,0.6)}
.brand{font-weight:800;font-size:26px}
.card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(2,6,23,0.5)}
.form-row{display:flex;flex-direction:column;gap:8px;margin-top:8px}
label{font-size:13px;color:var(--muted)}
input[type="text"], input[type="password"], input[type="file"], select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(12,16,28,0.6);color:#e6eef8}
.row{display:flex;gap:10px;align-items:center}
.btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;transition:all .16s cubic-bezier(.2,.9,.3,1)}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
.btn-primary:hover{transform:scale(1.05);background:linear-gradient(90deg,var(--accent-2),#3f7bff);box-shadow:0 10px 30px rgba(43,98,255,0.14)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.small{font-size:13px;color:var(--muted)}

/* right - app */
.app{flex:1;display:flex;gap:18px}
.sidebar{width:300px;background:linear-gradient(180deg,rgba(8,12,25,0.96),rgba(6,10,18,0.96));padding:18px;border-radius:12px;height:calc(100vh - 64px);position:sticky;top:32px;overflow:auto;border:1px solid rgba(255,255,255,0.02)}
.logo{font-size:18px;font-weight:800;margin-bottom:12px}
.user-short{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.avatar{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:20px}
.menu-title{margin-top:14px;color:var(--muted);font-size:12px;text-transform:uppercase}
.menu-item{padding:10px;border-radius:8px;cursor:pointer;margin-top:8px;display:flex;align-items:center;gap:10px}
.menu-item:hover{background:rgba(43,98,255,0.06)}
.menu-item.active{background:rgba(43,98,255,0.12);border-left:3px solid var(--accent-2);padding-left:7px}
.main{flex:1;background:linear-gradient(180deg,rgba(8,12,20,0.6),rgba(6,10,18,0.6));padding:20px;border-radius:12px;height:calc(100vh - 64px);overflow:auto}
.header{display:flex;justify-content:space-between;align-items:center}
.servers-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px}
.server-card{padding:14px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));cursor:pointer;transition:all .16s}
.server-card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 8px 30px rgba(2,6,23,0.5)}
.server-card.selected{outline:2px solid rgba(43,98,255,0.12)}
.tabs{display:flex;gap:8px;margin-top:14px}
.tab{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}

/* list & ban style */
.list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
.role-badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;background:linear-gradient(90deg,#ffd700,#ffaa00);color:#111}
.ban-card{background:#0b0d11;border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:flex-start}
.ban-left{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700}
.badge-red{background:rgba(239,68,68,0.12);color:#ffb4b4;padding:6px 8px;border-radius:8px;font-weight:700;font-size:13px}

/* ban overlay (full-screen blocking) */
.ban-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:999;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.8))}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:120}
.modal{width:520px;background:rgba(8,12,20,0.96);padding:18px;border-radius:12px}

.debug-note{font-size:12px;color:#ffd2d2;background:rgba(255,200,200,0.06);padding:8px;border-radius:8px;margin-top:8px}

@media (max-width:980px){
  .welcome{display:none}
  .sidebar{display:none}
  .main{height:auto}
  .container{padding:18px}
}
</style>
</head>
<body>
  <div class="bg-deco"><div class="orb bg-orb-1"></div><div class="orb bg-orb-2"></div></div>

  <div class="container">
    <!-- Left: login -->
    <section class="welcome">
      <div class="hero card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="brand">Discord Rang-System</div>
            <h1 style="margin:6px 0 0 0">Admin & Rollen</h1>
            <p class="small" style="margin-top:6px">Login lokal (JSON). Sp√§ter austauschbar gegen Discord OAuth2.</p>
          </div>
          <div class="small">v1 ‚Ä¢ Demo</div>
        </div>
      </div>

      <div class="card">
        <h3>Login</h3>
        <div class="form-row"><label>Benutzername</label><input id="loginUser" type="text" placeholder="Emilian"></div>
        <div class="form-row"><label>Passwort</label><input id="loginPass" type="password" placeholder="Passwort"></div>
        <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
          <button class="btn btn-primary" onclick="login()">Einloggen</button>
          <button class="btn btn-ghost" onclick="openRegister()">Registrieren</button>
          <div style="flex:1;text-align:right"><button class="btn btn-ghost" onclick="exportAccounts()">Export JSON</button></div>
        </div>
        <div style="margin-top:12px" class="small">Session wird im Browser gespeichert ‚Äî du bleibst eingeloggt.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Import / Export Accounts</h4>
        <div class="small">Importiert/Exportiert accounts.json</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <input id="importFileInput" type="file" accept=".json"/>
          <button class="btn btn-primary" onclick="importAccounts()">Import</button>
        </div>
      </div>
    </section>

    <!-- Right: app -->
    <section class="app" id="appArea" style="display:none">
      <aside class="sidebar">
        <div class="logo">Rang-System</div>
        <div class="user-short">
          <div class="avatar" id="avatar">A</div>
          <div><div id="displayName">Guest</div><div class="small" id="displayId">#0000</div></div>
        </div>

        <div class="menu-title">Navigation</div>
        <div class="menu-item active" data-section="servers" onclick="nav(event)">üè† Server</div>
        <div class="menu-item" data-section="roles" onclick="nav(event)">‚≠ê Rollen</div>
        <div class="menu-item" data-section="admin" onclick="nav(event)" id="adminMenuItem" style="display:none">üõ†Ô∏è Admin</div>
        <div class="menu-item" data-section="bans" onclick="nav(event)">‚õî Bans</div>
        <div class="menu-item" data-section="debug" onclick="nav(event)" id="debugMenuItem" style="display:none">üêû Debug</div>

        <div class="menu-title">Deine Server</div>
        <div id="serverList"></div>

        <div style="margin-top:18px"><button class="btn btn-primary" onclick="openModal('createServerModal')">Neuen Server</button></div>
        <div style="margin-top:12px"><button class="btn btn-ghost" onclick="logout()">Abmelden</button></div>
      </aside>

      <main class="main">
        <div class="header">
          <div>
            <h2 id="pageTitle">Server</h2>
            <p class="small" id="pageDesc">W√§hle einen Server oder erstelle einen neuen.</p>
          </div>
          <div id="userSummary" class="small">‚Äî</div>
        </div>

        <!-- Servers -->
        <div id="serversSection" class="card" style="margin-top:12px">
          <h3>Deine Server</h3>
          <p class="small">Klicke einen Server links an.</p>
          <div class="servers-grid" id="serversGrid"></div>
        </div>

        <!-- Tabs: roles/admin/bans rendered via nav -->
        <div id="rolesSection" class="card" style="display:none;margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3>Rollen</h3><div class="small">Owner kann Rollen erstellen.</div></div>
            <div><button class="btn btn-primary" onclick="openModal('createRoleModal')">Neue Rolle</button></div>
          </div>
          <div id="rolesList" class="list"></div>

          <div class="card" style="margin-top:12px;padding:12px">
            <h4>Mitglieder</h4>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="newMemberName" placeholder="Benutzername"/>
              <button class="btn btn-primary" onclick="addMember()">Hinzuf√ºgen</button>
            </div>
            <div id="membersList" class="list" style="margin-top:12px"></div>
          </div>
        </div>
        <div id="adminSection" class="card" style="display:none;margin-top:12px">
          <h3>Admin-Panel</h3>
          <div class="small">Nur sichtbar f√ºr Owner oder mit Permission <code>ManagePlayers</code></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <select id="adminTargetSelect"></select>
            <button class="btn btn-primary" onclick="openModal('banModal')">Ban</button>
            <button class="btn btn-ghost" onclick="kickDemo()">Kick</button>
            <button class="btn btn-ghost" onclick="unbanSelected()">Unban</button>
          </div>

          <div style="margin-top:12px">
            <h4>Banned √úbersicht</h4>
            <div id="banOverview"></div>
          </div>
        </div>

        <div id="bansSection" class="card" style="display:none;margin-top:12px">
          <h3>Aktive Bans</h3>
          <div id="bansGrid" style="margin-top:12px"></div>
        </div>

        <!-- Debug Section (only visible to debug account) -->
        <div id="debugSection" class="card" style="display:none;margin-top:12px">
          <h3>Debug ‚Äî Global Ban Tools</h3>
          <div class="small">Nur sichtbar wenn du als spezieller Website-Ersteller angemeldet bist.</div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <input id="debugTargetInput" placeholder="Benutzername oder User-ID (z.B. u_...)" />
            <button class="btn btn-primary" onclick="debugBan()">Global Ban</button>
          </div>
          <div style="margin-top:12px">
            <label>Grund</label>
            <input id="debugReason" placeholder="Custom Grund..." />
            <label style="margin-top:8px">Moderator-Notiz (sichtbar in UI)</label>
            <input id="debugNote" placeholder="Moderator-Note..." />
            <label style="margin-top:8px">Dauer</label>
            <select id="debugDuration">
              <option value="3600">1 Stunde</option>
              <option value="86400">1 Tag</option>
              <option value="604800">7 Tage</option>
              <option value="2592000">30 Tage</option>
              <option value="0">Permanent</option>
              <option value="custom">Benutzerdefiniert (Sekunden)</option>
            </select>
            <input id="debugCustomSeconds" style="display:none;margin-top:8px" placeholder="Sekunden (z.B. 7200)" />
          </div>

          <div class="debug-note">Debug-Tab: Mit Vorsicht verwenden ‚Äî Global-Bans entfernen Zugang zur gesamten Website.</div>

          <div style="margin-top:12px">
            <h4>Globale Bans</h4>
            <div id="globalBansList" class="list"></div>
          </div>
        </div>

      </main>
    </section>
  </div>

  <!-- Ban overlay (blocks all interaction while visible) -->
  <div class="ban-overlay" id="banOverlay">
    <div style="max-width:720px;width:92%;padding:22px;background:#0b0d11;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:16px;align-items:flex-start;flex-direction:column;">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800">‚õî</div>
          <div>
            <div style="font-weight:900;font-size:20px" id="banTitle">Banned</div>
            <div style="color:var(--muted);font-size:13px">Dein Account wurde gebannt ‚Äî Details unten.</div>
          </div>
        </div>
        <div style="color:var(--muted);font-size:13px" id="banShortMeta"></div>
      </div>

      <div style="width:100%;display:flex;gap:12px">
        <div style="width:78px;height:78px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:28px">!</div>
        <div style="flex:1">
          <div style="font-weight:800" id="banUserTitle">You were banned</div>
          <div style="margin-top:8px;color:var(--muted)" id="banReasonText">Grund: ...</div>

          <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
            <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px">
              <div style="font-size:13px;color:var(--muted)">Remaining</div>
              <div style="font-weight:900;font-size:18px" id="banRemaining">‚Äî</div>
            </div>

            <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px">
              <div style="font-size:13px;color:var(--muted)">Moderator</div>
              <div style="font-weight:700" id="banModerator">‚Äî</div>
            </div>

            <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px">
              <div style="font-size:13px;color:var(--muted)">Erstellt</div>
              <div style="font-weight:700" id="banCreated">‚Äî</div>
            </div>
          </div>

          <div style="margin-top:12px;color:var(--muted);font-size:13px">Wenn du denkst, dass das ein Fehler ist, erstelle einen Appeal oder kontaktiere admins.</div>
          <div style="margin-top:12px;text-align:right">
            <button class="btn btn-ghost" onclick="reportMistake()">Report a mistake</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal-back" id="modalBack">
    <div class="modal" id="createServerModal" style="display:none">
      <h3>Neuen Server erstellen</h3>
      <div style="margin-top:8px"><label>Server-Name</label><input id="serverNameInput" /></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeModal('createServerModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="createServer()">Erstellen</button>
      </div>
    </div>

    <div class="modal" id="createRoleModal" style="display:none">
      <h3>Rolle erstellen</h3>
      <div style="margin-top:8px"><label>Rollen-Name</label><input id="roleNameInput" /></div>
      <div style="margin-top:8px"><label>Badge-Text</label><input id="roleBadgeInput" placeholder="z.B. Support" /></div>
      <div style="margin-top:8px">
        <label>Berechtigungen</label>
        <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
          <label><input type="checkbox" id="permManagePlayers"> Manage-Players</label>
          <label><input type="checkbox" id="permBanMembers"> Ban-Members</label>
          <label><input type="checkbox" id="permCreateRoles"> Create-Roles</label>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeModal('createRoleModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveRole()">Speichern</button>
      </div>
    </div>

    <div class="modal" id="banModal" style="display:none">
      <h3>Spieler bannen</h3>
      <div style="margin-top:8px">
        <label>Spieler</label>
        <select id="banTargetSelect"></select>
      </div>
      <div style="margin-top:8px"><label>Grund (erforderlich)</label><input id="banReason" placeholder="Grund..." /></div>
      <div style="margin-top:8px">
        <label>Dauer</label>
        <select id="banDuration">
          <option value="3600">1 Stunde</option>
          <option value="86400">1 Tag</option>
          <option value="604800">7 Tage</option>
          <option value="2592000">30 Tage</option>
          <option value="0">Permanent</option>
          <option value="custom">Benutzerdefiniert (Sekunden)</option>
        </select>
        <input id="banCustomSeconds" style="display:none;margin-top:8px" placeholder="Sekunden (z.B. 7200)" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeModal('banModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="confirmBan()">Ban ausf√ºhren</button>
      </div>
    </div>

    <div class="modal" id="registerModal" style="display:none">
      <h3>Neues Konto registrieren</h3>
      <div style="margin-top:8px"><label>Benutzername</label><input id="regUser" /></div>
      <div style="margin-top:8px"><label>Passwort</label><input id="regPass" type="password" /></div>
      <div style="margin-top:8px"><label>Discriminator (4 Ziffern)</label><input id="regDisc" placeholder="0001" /></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeModal('registerModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="register()">Registrieren</button>
      </div>
    </div>
  </div>

<script>
/* STORAGE KEYS */
const ACC_KEY = 'ds_accounts_v1';
const APP_KEY = 'ds_appstate_v1';
const SESSION_KEY = 'ds_session_v1';

/* helpers */
function uid(prefix='id'){return prefix+'_'+Date.now()+'_'+Math.floor(Math.random()*8999+1000)}
function now(){return Date.now()}

/* accounts & app state */
function loadAccounts(){try{const r=localStorage.getItem(ACC_KEY);return r?JSON.parse(r):[]}catch(e){return[]}}
function saveAccounts(a){localStorage.setItem(ACC_KEY,JSON.stringify(a))}
function loadState(){try{const r=localStorage.getItem(APP_KEY);return r?JSON.parse(r):{servers:[],roles:{},members:{},bans:[],globalBans:[]}}catch(e){return{servers:[],roles:{},members:{},bans:[],globalBans:[]}}}
function saveState(){localStorage.setItem(APP_KEY,JSON.stringify(state))}

/* password encode simple */
function encodePass(p){return btoa(p)}
function verifyPass(p,enc){try{return btoa(p)===enc}catch(e){return false}}

/* app data */
let accounts = loadAccounts();
let state = loadState();
let currentUser = null;
let currentServer = null;
let editingRole = null;
let activeBan = null; // if user is currently banned

/* flag: debug access */
let sessionIsDebug = false; // stored in session when logging in with secret creds

/* UI helpers */
function openModal(id){document.getElementById('modalBack').style.display='flex';document.querySelectorAll('.modal').forEach(m=>m.style.display='none');document.getElementById(id).style.display='block'}
function closeModal(id){document.getElementById('modalBack').style.display='none'; if(id) document.getElementById(id).style.display='none'}
document.getElementById('modalBack').addEventListener('click',(ev)=>{ if(ev.target===document.getElementById('modalBack')){ document.getElementById('modalBack').style.display='none'; document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); } })

/* register / import / export */
function openRegister(){ openModal('registerModal') }
function register(){
  const user = document.getElementById('regUser').value.trim();
  const pass = document.getElementById('regPass').value;
  let disc = document.getElementById('regDisc').value.trim();
  if(!user||!pass){ alert('Benutzername & Passwort erforderlich'); return; }
  if(!disc) disc = String(Math.floor(Math.random()*9000+1000));
  if(disc.length!==4) disc = disc.padStart(4,'0').slice(0,4);
  if(accounts.find(a=>a.name.toLowerCase()===user.toLowerCase() && a.disc===disc)){ alert('Konto bereits vorhanden'); return; }
  const acc = { id: uid('u'), name: user, disc: disc, pass: encodePass(pass) };
  accounts.push(acc); saveAccounts(accounts);
  closeModal('registerModal'); alert('Registriert! Einloggen m√∂glich.');
  document.getElementById('regUser').value=''; document.getElementById('regPass').value=''; document.getElementById('regDisc').value='';
}
function exportAccounts(){
  const dataStr = JSON.stringify(accounts,null,2);
  const blob = new Blob([dataStr],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'accounts.json'; a.click(); URL.revokeObjectURL(url);
}
function importAccounts(){
  const inp = document.getElementById('importFileInput'); if(!inp.files||!inp.files[0]) return alert('W√§hle JSON');
  const f = inp.files[0]; const r=new FileReader();
  r.onload = e => { try{ const d = JSON.parse(e.target.result); if(!Array.isArray(d)) return alert('Ung√ºltiges Format'); accounts = d; saveAccounts(accounts); alert('Accounts importiert (√ºberschrieben).'); }catch(err){ alert('Import-Fehler: '+err.message) } };
  r.readAsText(f);
}

/* session */
function saveSession(uid, isDebug=false){ localStorage.setItem(SESSION_KEY, JSON.stringify({ userId: uid, ts: Date.now(), debug: !!isDebug })) }
function loadSession(){ try{ const r = localStorage.getItem(SESSION_KEY); return r?JSON.parse(r):null }catch(e){return null} }
function clearSession(){ localStorage.removeItem(SESSION_KEY) }

/* login / logout
   special debug credentials:
   Benutzer: Kungen25003
   Passwort: Emilian_120613
*/
const DEBUG_USER = 'Kungen25003';
const DEBUG_PASS = 'Emilian_120613';

function login(){
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!user||!pass) return alert('Benutzername & Passwort n√∂tig');

  // check debug credentials first (these bypass account matching for debug access)
  let isDebug = false;
  if(user === DEBUG_USER && pass === DEBUG_PASS){
    // find or create account for debug user in accounts list (so debug user exists)
    let acc = accounts.find(a => a.name === DEBUG_USER);
    if(!acc){
      acc = { id: uid('u'), name: DEBUG_USER, disc: String(Math.floor(Math.random()*9000+1000)), pass: encodePass(pass) };
      accounts.push(acc); saveAccounts(accounts);
    }
    currentUser = { id: acc.id, name: acc.name, discriminator: acc.disc };
    isDebug = true;
    sessionIsDebug = true;
    saveSession(acc.id, true);
    afterLogin();
    return;
  }

  // normal login
  const acc = accounts.find(a=>a.name.toLowerCase()===user.toLowerCase());
  if(!acc) return alert('Konto nicht gefunden. Registriere dich.');
  if(!verifyPass(pass, acc.pass)) return alert('Falsches Passwort');
  currentUser = { id: acc.id, name: acc.name, discriminator: acc.disc };
  sessionIsDebug = false;
  saveSession(acc.id, false);
  afterLogin();
}

function logout(){
  if(!confirm('Abmelden?')) return;
  currentUser = null; currentServer = null; activeBan = null; sessionIsDebug = false;
  clearSession();
  document.getElementById('appArea').style.display='none'; document.querySelector('.welcome').style.display='block';
  document.getElementById('loginUser').value=''; document.getElementById('loginPass').value='';
}

/* after login initialization */
function afterLogin(){
  // UI
  document.getElementById('displayName').textContent = currentUser.name;
  document.getElementById('displayId').textContent = '#'+currentUser.discriminator;
  document.getElementById('avatar').textContent = currentUser.name.charAt(0).toUpperCase();
  document.getElementById('userSummary').textContent = `Angemeldet als ${currentUser.name}#${currentUser.discriminator}`;
  document.getElementById('appArea').style.display='flex';
  document.querySelector('.welcome').style.display='none';
  // ensure user present in members when creating servers later (no-op for now)
  renderAll();
  // restore debug menu based on session flag
  const sess = loadSession();
  if(sess && sess.debug) sessionIsDebug = true; else sessionIsDebug = false;
  toggleDebugMenu();
  checkActiveBansAndShow();
}

/* server create/select */
function createServer(){
  const name = document.getElementById('serverNameInput').value.trim();
  if(!name) return alert('Servername angeben');
  const srv = { id: uid('srv'), name, ownerId: currentUser.id };
  state.servers.push(srv);
  state.roles[srv.id] = [];
  state.members[srv.id] = [];
  state.members[srv.id].push({ id: currentUser.id, name: currentUser.name, roles: [] });
  const ownerRole = { id: uid('role'), name:'Owner', badge:'Owner', perms:{ ManagePlayers:true, BanMembers:true, CreateRoles:true }, immutable:true };
  state.roles[srv.id].push(ownerRole);
  state.members[srv.id][0].roles.push(ownerRole.id);
  saveState(); closeModal('createServerModal'); document.getElementById('serverNameInput').value=''; renderAll(); selectServer(srv.id);
}
function updateServerListUI(){
  const list = document.getElementById('serverList');
  list.innerHTML = state.servers.length ? state.servers.map(s=>`<div class="menu-item" style="cursor:pointer" onclick="selectServer('${s.id}')">${s.name}</div>`).join('') : '<div class="small">Keine Server</div>';
  renderServersGrid();
}
function selectServer(id){
  currentServer = state.servers.find(s=>s.id===id);
  if(!currentServer) return;
  document.getElementById('pageTitle').textContent = currentServer.name;
  document.getElementById('pageDesc').textContent = 'Verwalte Server: ' + currentServer.name;
  toggleAdminMenu(); renderRoles(); renderMembers(); renderAdmin(); renderBansGrid();
}

/* render servers grid */
function renderServersGrid(){
  const grid = document.getElementById('serversGrid');
  if(!grid) return;
  if(state.servers.length===0){ grid.innerHTML = `<div class="server-card"><div style="font-weight:700">Noch keine Server</div><div class="small">Erstelle einen Server in der Sidebar</div></div>`; return; }
  grid.innerHTML = state.servers.map(s=>`<div class="server-card ${(currentServer && currentServer.id===s.id)?'selected':''}" onclick="selectServer('${s.id}')"><div style="font-weight:900">${s.name}</div><div class="small">${(state.members[s.id]||[]).length} Mitglieder</div></div>`).join('');
}

/* roles */
function renderRoles(){
  const el = document.getElementById('rolesList');
  if(!currentServer) return el.innerHTML = '<div class="small">W√§hle zuerst einen Server.</div>';
  const roles = state.roles[currentServer.id] || [];
  if(!roles.length) return el.innerHTML = '<div class="small">Keine Rollen</div>';
  el.innerHTML = roles.map(r=>`<div class="list-item"><div><div style="font-weight:800">${r.name} ${r.immutable?'<span class="small">(System)</span>':''}</div><div class="small">Perms: ${Object.keys(r.perms||{}).filter(k=>r.perms[k]).join(', ')||'keine'}</div></div><div style="display:flex;gap:8px">${canCurrentUser('CreateRoles') && !r.immutable?`<button class="btn btn-ghost" onclick="editRole('${r.id}')">Bearbeiten</button><button class="btn" style="background:rgba(220,38,38,0.12);color:#ffb4b4" onclick="deleteRole('${r.id}')">L√∂schen</button>`:''}</div></div>`).join('');
}
function saveRole(){
  if(!currentServer) return alert('W√§hle Server'); if(!canCurrentUser('CreateRoles')) return alert('Keine Berechtigung');
  const name = document.getElementById('roleNameInput').value.trim(); if(!name) return alert('Rollenname');
  const badge = document.getElementById('roleBadgeInput').value.trim() || name;
  const perms = { ManagePlayers:!!document.getElementById('permManagePlayers').checked, BanMembers:!!document.getElementById('permBanMembers').checked, CreateRoles:!!document.getElementById('permCreateRoles').checked };
  if(editingRole){ const arr = state.roles[currentServer.id]; const idx = arr.findIndex(r=>r.id===editingRole); if(idx>=0){ arr[idx].name=name; arr[idx].badge=badge; arr[idx].perms=perms; } }
  else { const r = { id: uid('role'), name, badge, perms }; state.roles[currentServer.id].push(r); }
  editingRole = null; saveState(); closeModal('createRoleModal'); renderRoles(); renderMembers();
}
function editRole(roleId){ const r = (state.roles[currentServer.id]||[]).find(rr=>rr.id===roleId); if(!r) return; editingRole = roleId; document.getElementById('roleNameInput').value=r.name; document.getElementById('roleBadgeInput').value=r.badge||r.name; document.getElementById('permManagePlayers').checked=!!r.perms.ManagePlayers; document.getElementById('permBanMembers').checked=!!r.perms.BanMembers; document.getElementById('permCreateRoles').checked=!!r.perms.CreateRoles; openModal('createRoleModal'); }
function deleteRole(roleId){ if(!confirm('Rolle wirklich l√∂schen?')) return; state.roles[currentServer.id] = (state.roles[currentServer.id]||[]).filter(r=>r.id!==roleId); (state.members[currentServer.id]||[]).forEach(m=>m.roles=(m.roles||[]).filter(rr=>rr!==roleId)); saveState(); renderRoles(); renderMembers(); }
/* ========== Restliche Funktionen (Fortsetzung) ========== */

/* members */
function addMember(){ 
  if(!currentServer) return alert('W√§hle Server'); 
  const name = document.getElementById('newMemberName').value.trim(); 
  if(!name) return; 
  const mem = { id: uid('m'), name, roles:[] }; 
  state.members[currentServer.id].push(mem); 
  saveState(); 
  document.getElementById('newMemberName').value=''; 
  renderMembers(); 
  renderAdmin(); 
}

function renderMembers(){ 
  const el = document.getElementById('membersList'); 
  if(!currentServer) return el.innerHTML = '<div class="small">W√§hle Server</div>'; 
  const members = state.members[currentServer.id]||[]; 
  const roles = state.roles[currentServer.id]||[]; 
  if(!members.length) return el.innerHTML = '<div class="small">Keine Mitglieder</div>'; 
  el.innerHTML = members.map(m=>{ 
    const badges = (m.roles||[]).map(rid=>{ const r = roles.find(rr=>rr.id===rid); return r?`<span style="margin-right:6px" class="role-badge">${r.badge||r.name}</span>`:'' }).join(''); 
    const options = roles.map(r=>`<option value="${r.id}">${r.name}</option>`).join(''); 
    return `<div class="list-item"><div><div style="font-weight:800">${m.name} ${m.id===currentServer.ownerId?'<span class="small">(Owner)</span>':''}</div><div class="small">${badges||'keine Rolle'}</div></div><div style="display:flex;gap:8px;align-items:center"><select id="assign_${m.id}"><option value="">Rolle hinzuf√ºgen</option>${options}</select><button class="btn btn-ghost" onclick="assignRoleToMember('${m.id}')">Zuweisen</button>${m.id!==currentServer.ownerId?`<button class="btn" style="background:rgba(220,38,38,0.12);color:#ffb4b4" onclick="removeMember('${m.id}')">Entfernen</button>`:''}</div></div>` 
  }).join(''); 
}

function assignRoleToMember(memberId){ 
  if(!canCurrentUser('CreateRoles')) return alert('Keine Berechtigung'); 
  const select = document.getElementById('assign_'+memberId); if(!select) return; 
  const roleId = select.value; if(!roleId) return; 
  const member = (state.members[currentServer.id]||[]).find(m=>m.id===memberId); if(!member) return; 
  if(member.roles.includes(roleId)) return alert('Hat Rolle bereits'); 
  member.roles.push(roleId); saveState(); renderMembers(); renderAdmin(); 
}

function removeMember(memberId){ 
  if(!confirm('Mitglied entfernen?')) return; 
  state.members[currentServer.id] = (state.members[currentServer.id]||[]).filter(m=>m.id!==memberId); 
  saveState(); renderMembers(); renderAdmin(); 
}

/* permissions & admin menu */
function canCurrentUser(permName){ 
  if(!currentServer) return false; 
  if(!currentUser) return false; 
  if(currentUser.id === currentServer.ownerId) return true; 
  const members = state.members[currentServer.id]||[]; const me = members.find(m=>m.id===currentUser.id); 
  if(!me) return false; 
  const roles = state.roles[currentServer.id]||[]; 
  for(const rid of (me.roles||[])){ const r = roles.find(rr=>rr.id===rid); if(r && r.perms && r.perms[permName]) return true; } 
  return false; 
}

function toggleAdminMenu(){ 
  const it = document.getElementById('adminMenuItem'); 
  if(!currentServer || !currentUser){ it.style.display='none'; } 
  else if(currentUser.id === currentServer.ownerId || canCurrentUser('ManagePlayers')) it.style.display=''; 
  else it.style.display='none'; 
  // debug menu visibility
  toggleDebugMenu();
}

function toggleDebugMenu(){
  const dbg = document.getElementById('debugMenuItem');
  if(sessionIsDebug) dbg.style.display = '';
  else dbg.style.display = 'none';
}

/* admin rendering */
function renderAdmin(){ 
  toggleAdminMenu(); 
  if(!currentServer) return; 
  const sel = document.getElementById('adminTargetSelect'); 
  const banSel = document.getElementById('banTargetSelect'); 
  const members = state.members[currentServer.id]||[]; 
  const opts = members.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); 
  if(sel) sel.innerHTML = opts; 
  if(banSel) banSel.innerHTML = opts; 
  renderBanOverview(); 
}

/* ban system (per-server bans already mostly implemented above) */
document.getElementById('banDuration').addEventListener('change', function(){ document.getElementById('banCustomSeconds').style.display = this.value==='custom' ? '' : 'none'; });

function confirmBan(){
  if(!currentServer) return alert('W√§hle Server'); 
  if(!(canCurrentUser('ManagePlayers') || canCurrentUser('BanMembers') || currentUser.id===currentServer.ownerId)) return alert('Keine Berechtigung');
  const tid = document.getElementById('banTargetSelect').value; const reason = document.getElementById('banReason').value.trim(); let duration = document.getElementById('banDuration').value; const custom = document.getElementById('banCustomSeconds').value.trim();
  if(!tid||!reason) return alert('Ziel & Grund erforderlich');
  if(duration==='custom'){ duration = parseInt(custom||'0',10); if(isNaN(duration)||duration<0) return alert('Ung√ºltige Dauer'); } else duration = parseInt(duration,10);
  const member = (state.members[currentServer.id]||[]).find(m=>m.id===tid); if(!member) return alert('Mitglied nicht gefunden');
  const expiresAt = duration===0 ? 0 : Date.now() + duration*1000;
  const ban = { id: uid('ban'), serverId: currentServer.id, userId: member.id, userName: member.name, reason, expiresAt, bannedBy: currentUser.name, createdAt: Date.now() };
  state.bans.push(ban); saveState(); closeModal('banModal'); renderBansGrid(); renderAdmin(); alert('Gebannt: '+member.name);
  if(currentUser && currentUser.id === member.id) { checkActiveBansAndShow(true); }
}

function unbanSelected(){ 
  if(!currentServer) return; 
  if(!(canCurrentUser('ManagePlayers') || canCurrentUser('BanMembers') || currentUser.id===currentServer.ownerId)) return alert('Keine Berechtigung');
  const sel = document.getElementById('adminTargetSelect'); if(!sel) return alert('W√§hle Mitglied'); const memberId = sel.value;
  state.bans = state.bans.filter(b=>!(b.serverId===currentServer.id && b.userId===memberId)); saveState(); renderBansGrid(); renderAdmin(); alert('Unban durchgef√ºhrt');
}

function kickDemo(){ 
  if(!currentServer) return; 
  if(!canCurrentUser('ManagePlayers')) return alert('Keine Berechtigung');
  const sel = document.getElementById('adminTargetSelect'); if(!sel) return alert('W√§hle Mitglied'); 
  const id = sel.value; if(id===currentServer.ownerId) return alert('Owner kann nicht gekickt werden');
  state.members[currentServer.id] = state.members[currentServer.id].filter(m=>m.id!==id);
  saveState(); renderMembers(); renderAdmin(); alert('Mitglied gekickt (Demo)');
}

/* Bans UI rendering */
function renderBansGrid(){ 
  const grid = document.getElementById('bansGrid'); if(!grid) return; 
  const rows = state.bans.filter(b=>b.serverId === (currentServer && currentServer.id)); 
  if(rows.length===0){ grid.innerHTML = '<div class="small">Keine aktiven Bans</div>'; return; } 
  grid.innerHTML = rows.map(b=>{ const remaining = b.expiresAt===0 ? 'Permanent' : formatRemaining(b.expiresAt - Date.now()); const expired = (b.expiresAt!==0 && Date.now() > b.expiresAt); return `<div class="ban-card"><div class="ban-left">${b.userName.charAt(0).toUpperCase()}</div><div style="flex:1"><div style="font-weight:800">${b.userName} <span class="small">‚Äî gebannt von ${b.bannedBy}</span></div><div class="small">${b.reason}</div><div style="margin-top:8px;display:flex;gap:8px;align-items:center"><div class="badge-red">${expired?'Abgelaufen':remaining}</div><div class="small">erstellt: ${new Date(b.createdAt).toLocaleString()}</div></div></div>${(canCurrentUser('ManagePlayers')||canCurrentUser('BanMembers')||currentUser.id===currentServer.ownerId)?`<div style="display:flex;flex-direction:column;gap:8px"><button class="btn" onclick="removeBan('${b.id}')">Unban</button></div>`:''}</div>` }).join(''); 
}

function renderBanOverview(){ 
  const el = document.getElementById('banOverview'); if(!el) return; 
  const rows = state.bans.filter(b=>b.serverId === (currentServer && currentServer.id)); 
  if(rows.length===0) return el.innerHTML = '<div class="small">Keine Bans</div>'; 
  el.innerHTML = rows.map(b=>`<div class="list-item"><div><div style="font-weight:800">${b.userName}</div><div class="small">${b.reason} ‚Äî ${(b.expiresAt===0?'Permanent':formatRemaining(b.expiresAt-Date.now()))}</div></div><div><button class="btn btn-ghost" onclick="removeBan('${b.id}')">Unban</button></div></div>`).join(''); 
}

function removeBan(banId){ 
  if(!(canCurrentUser('ManagePlayers')||canCurrentUser('BanMembers')||currentUser.id===currentServer.ownerId)) return alert('Keine Berechtigung'); 
  state.bans = state.bans.filter(b=>b.id!==banId); saveState(); renderBansGrid(); renderBanOverview(); checkActiveBansAndShow(); 
}

/* auto-clean expired bans */
setInterval(()=>{ const before=state.bans.length; state.bans = state.bans.filter(b=>!(b.expiresAt!==0 && Date.now()>b.expiresAt)); if(state.bans.length!==before){ saveState(); renderBansGrid(); renderBanOverview(); } }, 5000);

/* ========== Global Debug / Global Bans ========== */
document.getElementById('debugDuration').addEventListener('change', function(){ document.getElementById('debugCustomSeconds').style.display = this.value==='custom' ? '' : 'none'; });

function debugBan(){
  // only allow if sessionIsDebug true
  if(!sessionIsDebug) return alert('Keine Berechtigung f√ºr Debug-Tab');
  const target = document.getElementById('debugTargetInput').value.trim();
  const reason = document.getElementById('debugReason').value.trim();
  const note = document.getElementById('debugNote').value.trim();
  let duration = document.getElementById('debugDuration').value;
  const custom = document.getElementById('debugCustomSeconds').value.trim();
  if(!target || !reason) return alert('Ziel & Grund erforderlich');
  if(duration === 'custom'){ duration = parseInt(custom||'0',10); if(isNaN(duration) || duration < 0) return alert('Ung√ºltige Dauer'); } else duration = parseInt(duration,10);
  const expiresAt = duration === 0 ? 0 : Date.now() + duration*1000;
  // find if target is user-id or username; store both optionally
  let userId = null;
  const maybe = accounts.find(a=> a.id === target || a.name.toLowerCase() === target.toLowerCase());
  if(maybe) userId = maybe.id;
  const gb = { id: uid('gban'), userId, userName: maybe ? maybe.name : target, reason, note, expiresAt, bannedBy: 'DEBUG('+currentUser.name+')', createdAt: Date.now() };
  if(!Array.isArray(state.globalBans)) state.globalBans = [];
  state.globalBans.push(gb);
  // also save as normal ban entries on all servers where user exists (optional)
  if(userId){
    state.servers.forEach(s=>{
      (state.members[s.id]||[]).forEach(m=>{
        if(m.id === userId){
          // create server-ban entry if not already banned
          const exists = state.bans.find(b => b.serverId===s.id && b.userId===userId && b.reason===reason && b.bannedBy===gb.bannedBy);
          if(!exists){
            const ban = { id: uid('ban'), serverId: s.id, userId, userName: m.name, reason, expiresAt, bannedBy: gb.bannedBy, createdAt: Date.now() };
            state.bans.push(ban);
          }
        }
      });
    });
  }
  saveState();
  renderGlobalBans();
  renderBansGrid();
  renderBanOverview();
  alert('Global-Ban angelegt: ' + (gb.userName || target));
  // if current logged-in user is the target, show overlay
  if(currentUser && (userId && currentUser.id===userId || currentUser.name.toLowerCase() === target.toLowerCase())) checkActiveBansAndShow(true);
}

function renderGlobalBans(){
  const el = document.getElementById('globalBansList');
  if(!el) return;
  if(!state.globalBans || state.globalBans.length===0) return el.innerHTML = '<div class="small">Keine globalen Bans</div>';
  el.innerHTML = state.globalBans.map(g=>{
    const remaining = g.expiresAt===0 ? 'Permanent' : formatRemaining(g.expiresAt - Date.now());
    const expired = g.expiresAt!==0 && Date.now() > g.expiresAt;
    return `<div class="list-item"><div><div style="font-weight:800">${g.userName}</div><div class="small">${g.reason} ‚Äî ${(expired ? 'Abgelaufen' : remaining)}</div></div><div style="display:flex;gap:8px"><button class="btn btn-ghost" onclick="removeGlobalBan('${g.id}')">Unban Global</button></div></div>`;
  }).join('');
}

function removeGlobalBan(id){
  if(!sessionIsDebug) return alert('Keine Berechtigung');
  state.globalBans = (state.globalBans||[]).filter(g=>g.id!==id);
  saveState();
  renderGlobalBans();
  alert('Global-Ban entfernt');
}

/* check global bans & per-server bans for current user and show overlay */
function checkActiveBansAndShow(immediate=false){
  if(!currentUser) return;
  // first check global bans
  const g = (state.globalBans||[]).find(b => {
    if(b.expiresAt !== 0 && Date.now() > b.expiresAt) return false; // expired
    if(b.userId && b.userId === currentUser.id) return true;
    if(b.userName && b.userName.toLowerCase() === currentUser.name.toLowerCase()) return true;
    return false;
  });
  if(g){
    activeBan = { type: 'global', info: g };
    showBanOverlayFromGlobal(g);
    return;
  }
  // then check per-server bans (any server)
  const active = state.bans.find(b => b.userId === currentUser.id && (b.expiresAt===0 || Date.now() < b.expiresAt));
  if(active){
    activeBan = { type: 'server', info: active };
    showBanOverlay(active); // reuse existing overlay function
  } else {
    activeBan = null;
    hideBanOverlay();
  }
}

/* show overlay for global ban (slightly different content) */
function showBanOverlayFromGlobal(gban){
  const overlay = document.getElementById('banOverlay');
  document.getElementById('banTitle').textContent = `Banned (Global)`;
  document.getElementById('banUserTitle').textContent = `${gban.userName} ‚Äî gebannt`;
  document.getElementById('banReasonText').textContent = `Grund: ${gban.reason}\nModerator-Note: ${gban.note || '-'}`;
  document.getElementById('banModerator').textContent = gban.bannedBy || 'Website Admin';
  document.getElementById('banCreated').textContent = new Date(gban.createdAt).toLocaleString();
  document.getElementById('banShortMeta').textContent = `Global Ban`;
  overlay.style.display = 'flex';
  if(banTimer) clearInterval(banTimer);
  function update(){
    // find updated record
    const latest = (state.globalBans||[]).find(x => x.id === gban.id);
    if(!latest){ hideBanOverlay(); return; }
    if(latest.expiresAt === 0) { document.getElementById('banRemaining').textContent = '‚ôæÔ∏è  (Permanent / -1)'; return; }
    const rem = latest.expiresAt - Date.now();
    if(rem <= 0){ // expired -> remove and hide
      state.globalBans = (state.globalBans||[]).filter(x=>x.id!==latest.id); saveState(); hideBanOverlay(); return;
    }
    document.getElementById('banRemaining').textContent = formatRemaining(rem);
  }
  update(); banTimer = setInterval(update, 1000);
}

/* show general/server ban overlay already implemented earlier */
let banTimer = null;
function showBanOverlay(ban){
  const overlay = document.getElementById('banOverlay');
  document.getElementById('banUserTitle').textContent = `${ban.userName} ‚Äî gebannt`;
  document.getElementById('banReasonText').textContent = `Grund: ${ban.reason}`;
  document.getElementById('banModerator').textContent = ban.bannedBy || 'Moderator';
  document.getElementById('banCreated').textContent = new Date(ban.createdAt).toLocaleString();
  document.getElementById('banShortMeta').textContent = `Server: ${ (state.servers.find(s=>s.id===ban.serverId)||{name:'Unbekannt'}).name }`;
  document.getElementById('banTitle').textContent = 'Banned';
  overlay.style.display = 'flex';
  if(banTimer) clearInterval(banTimer);
  function update(){
    const latest = state.bans.find(b=>b.id===ban.id);
    if(!latest){ hideBanOverlay(); return; }
    if(latest.expiresAt === 0){
      document.getElementById('banRemaining').textContent = '‚ôæÔ∏è  (Permanent / -1)';
      return;
    }
    const rem = latest.expiresAt - Date.now();
    if(rem <= 0){
      state.bans = state.bans.filter(b=>b.id!==latest.id); saveState(); hideBanOverlay(); return;
    }
    document.getElementById('banRemaining').textContent = formatRemaining(rem);
  }
  update(); banTimer = setInterval(update, 1000);
}

function hideBanOverlay(){
  const overlay = document.getElementById('banOverlay');
  overlay.style.display = 'none';
  if(banTimer){ clearInterval(banTimer); banTimer = null; }
  activeBan = null;
}

/* report mistake button */
function reportMistake(){
  alert('Feature not implemented yet');
}

/* nav */
function nav(e){
  const section = e.currentTarget.dataset.section;
  if(section !== 'servers' && !currentServer){ alert('W√§hle zuerst einen Server oder erstelle einen neuen.'); return; }
  document.querySelectorAll('.menu-item').forEach(it=>it.classList.remove('active'));
  e.currentTarget.classList.add('active');
  document.getElementById('serversSection').style.display = section==='servers' ? '' : 'none';
  document.getElementById('rolesSection').style.display = section==='roles' ? '' : 'none';
  document.getElementById('adminSection').style.display = section==='admin' ? '' : 'none';
  document.getElementById('bansSection').style.display = section==='bans' ? '' : 'none';
  document.getElementById('debugSection').style.display = section==='debug' ? '' : 'none';
  renderRoles(); renderMembers(); renderAdmin(); renderBansGrid(); renderGlobalBans();
}

/* helper */
function formatRemaining(ms){
  if(ms <= 0) return 'abgelaufen';
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400); const h = Math.floor((s%86400)/3600); const m = Math.floor((s%3600)/60); const sec = s%60;
  if(d>0) return `${d}d ${h}h ${m}m`;
  if(h>0) return `${h}h ${m}m`;
  if(m>0) return `${m}m ${sec}s`;
  return `${sec}s`;
}

/* render everything */
function renderAll(){
  accounts = loadAccounts(); state = loadState();
  if(!Array.isArray(state.globalBans)) state.globalBans = [];
  updateServerListUI(); renderServersGrid(); renderRoles(); renderMembers(); renderAdmin(); renderBansGrid(); renderGlobalBans();
}

/* init and session restore */
function init(){
  accounts = loadAccounts(); state = loadState();
  if(!Array.isArray(state.globalBans)) state.globalBans = [];
  const session = loadSession();
  if(session && session.userId){
    const acc = accounts.find(a=>a.id===session.userId);
    if(acc){ 
      currentUser = { id: acc.id, name: acc.name, discriminator: acc.disc };
      sessionIsDebug = !!session.debug;
      afterLogin();
      return;
    }
  }
  document.getElementById('appArea').style.display='none';
  document.querySelector('.welcome').style.display='block';
  renderAll();
}
init();

/* expose functions for onclick in html */
window.openModal = openModal; window.closeModal = closeModal; window.createServer = createServer; window.selectServer = selectServer;
window.addMember = addMember; window.assignRoleToMember = assignRoleToMember; window.saveRole = saveRole; window.editRole = editRole;
window.deleteRole = deleteRole; window.confirmBan = confirmBan; window.openRegister = openRegister; window.login = login;
window.logout = logout; window.exportAccounts = exportAccounts; window.importAccounts = importAccounts; window.removeBan = removeBan;
window.unbanSelected = unbanSelected; window.kickDemo = kickDemo; window.debugBan = debugBan; window.reportMistake = reportMistake;
</script>
</body>
</html>

